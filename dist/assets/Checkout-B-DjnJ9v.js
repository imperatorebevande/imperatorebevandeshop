import{j as e,s as ye,J as ss,K as as,t as rs,M as xe,O as mt,v as is,H as ns,q as os,Q as De,U as ut,W as Me,Y as pt,n as ls,Z as cs,_ as ds,$ as ms}from"./ui-vendor-CBu0MraC.js";import{r as m,a as Pe}from"./react-vendor-DTdTrAaS.js";import{L as V}from"./label-BP42n_nh.js";import{w as gt,J as I,u as It,a as us,g as ht}from"./index-I5fS8uHh.js";import{b as ps,c as gs,e as fe,f as xt,d as hs}from"./deliveryZones-DdzeKIHd.js";import{l as xs,E as fs,u as ys,a as vs,C as ft}from"./payment-vendor-B8ix3oHN.js";import{H as bs}from"./Header-Chz8Xda_.js";import{B as le,I as re}from"./input-BrCX-FV-.js";import{C as Ns,b as js,c as As,a as Cs}from"./card-CJGvcwoN.js";import{D as yt,a as vt,b as bt,c as Nt,d as jt,E as Ss}from"./EditAddress-DvKwgc6D.js";import{A as At,a as qe}from"./AddressAutocomplete-BRjemWj9.js";import{f as ws,g as Es,e as zs,h as Is,i as Ds}from"./useWooCommerce-izqWt-aK.js";import{T as Ps}from"./textarea-CaX30mO0.js";import{c as Ts}from"./router-vendor-C3VyKldT.js";import"./chart-vendor-tNssjKKI.js";import"./query-vendor-CZPvIwdz.js";import"./utils-vendor-BbYF_8OW.js";const _s=({formData:t,onDateTimeChange:r,deliveryZone:i})=>{const[o,u]=m.useState([]),[a,p]=m.useState([]),[f,E]=m.useState(t.deliveryDate?new Date(t.deliveryDate):void 0),[C,A]=m.useState([]),[N,D]=m.useState(!0),[U,K]=m.useState(!1),[ce,O]=m.useState(null);m.useEffect(()=>{i?console.log("🎯 Zona di consegna ricevuta nel calendario:",{id:i.id,name:i.name,description:i.description}):console.log("⚠️ Nessuna zona di consegna specificata nel calendario")},[i]);const H=["07:00 - 08:00","08:00 - 09:00","09:00 - 10:00","10:00 - 11:00","11:00 - 12:00","12:00 - 13:00","13:00 - 14:00","14:00 - 15:00","15:00 - 16:00"],y=c=>{const b=c.getFullYear(),v=String(c.getMonth()+1).padStart(2,"0"),j=String(c.getDate()).padStart(2,"0");return`${b}-${v}-${j}`},_=m.useCallback(async()=>{D(!0),O(null);try{const c=await gt.getDeliveryCalendar();let b=[];if(Array.isArray(c)?b=c:(c&&Array.isArray(c.data)||c&&c.success&&Array.isArray(c.data))&&(b=c.data),u(b),b&&b.length>0){const j=b.filter(T=>T.slots&&T.slots.length>0).map(T=>{const W=T.date.split("-"),Y=new Date(parseInt(W[0]),parseInt(W[1])-1,parseInt(W[2]));return Y.setHours(0,0,0,0),Y}).filter(T=>!isNaN(T.getTime())).sort((T,W)=>T.getTime()-W.getTime());p(j)}else p([]),A([])}catch(c){console.error("❌ Errore caricamento calendario:",c),O("Errore nel caricamento del calendario"),u([]),p([]),A([]),I.error("Errore nel caricamento delle date disponibili")}finally{D(!1)}},[]);m.useEffect(()=>{_()},[_]);const he=m.useCallback(async c=>{const b=y(c);console.log("🔄 Caricamento time slots dinamici per data:",b),K(!0);try{console.log("🔄 Chiamata API dinamica per:",b);const v=await gt.getDeliveryTimeSlotsForDate(b);if(v&&Array.isArray(v)&&v.length>0){let j=v.map(T=>T.time_slot).filter(Boolean);if(i){console.log(`🔍 Filtraggio time slots per zona ${i.name} (ID: ${i.id})`),console.log("📋 Time slots originali dall'API:",j);const T=ps(i.id),W=gs(i.id);console.log("❌ Fasce orarie escluse:",T),console.log("⭐ Fasce orarie raccomandate:",W);const Y=[...j];if(j=j.filter(oe=>!T.includes(oe)),T.length>0&&(console.log("🚫 Time slots dopo rimozione esclusi:",j),console.log("🗑️ Time slots rimossi:",Y.filter(oe=>!j.includes(oe)))),W.length>0){const oe=j.filter(te=>W.includes(te)),ge=j.filter(te=>!W.includes(te));j=[...oe,...ge],console.log("📊 Time slots riordinati (raccomandati primi):",j)}console.log(`✅ Time slots finali per zona ${i.name}:`,j)}else console.log("✅ Time slots dinamici disponibili (nessuna zona):",j);A(j)}else console.log("❌ Nessun time slot disponibile per questa data"),A([])}catch(v){console.error("❌ Errore nel caricamento time slots dinamici:",v),A([]),I.error("Errore nel caricamento delle fasce orarie")}finally{K(!1)}},[]);m.useEffect(()=>{f?(console.log("📅 Data selezionata cambiata:",y(f)),console.log("🎯 Zona corrente:",i?`${i.name} (${i.id})`:"Nessuna zona"),he(f)):A([])},[f,he,i]),m.useEffect(()=>{if(a.length>0&&!f){const c=new Date;c.setHours(0,0,0,0);let b=a[0];if(a.length>1){const v=new Date(a[0]);v.setHours(0,0,0,0),v.getTime()===c.getTime()&&(b=a[1])}console.log("🎯 Auto-selezione prima data disponibile:",y(b)),E(b),r(y(b),"")}},[a,f,r]);const pe=c=>{if(console.log("📅 Data selezionata manualmente:",c?y(c):"nessuna"),E(c),c){const b=y(c);r(b,""),setTimeout(()=>{const v=document.getElementById("time-slots-section");v&&v.scrollIntoView({behavior:"smooth",block:"start"})},100)}else r("",""),A([])},h=c=>{if(!f)return;const b=y(f);console.log("⏰ Slot orario selezionato:",c),r(b,c)},M=c=>{const b=new Date;if(b.setHours(0,0,0,0),c<=b)return!0;const v=y(c);return!a.some(j=>y(j)===v)};m.useEffect(()=>{if(Array.isArray(a)&&a.length>0&&!f){const c=setTimeout(()=>{const b=new Date;b.setHours(0,0,0,0);let v=a[0];if(a.length>1){const j=a[0],T=new Date(j);T.setHours(0,0,0,0),T.getTime()===b.getTime()&&(v=a[1])}v&&(E(v),r(y(v),""))},100);return()=>clearTimeout(c)}},[a,f,r]);const ne=c=>["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"][c.getMonth()],q=()=>["Lu","Ma","Me","Gi","Ve","Sa","Do"],k=c=>{const b=c.getFullYear(),v=c.getMonth(),j=new Date(b,v,1),T=new Date(j),W=j.getDay(),Y=W===0?6:W-1;T.setDate(j.getDate()-Y);const oe=[],ge=new Date(T);for(let te=0;te<42;te++)oe.push(new Date(ge)),ge.setDate(ge.getDate()+1);return oe},[F,Ae]=m.useState(new Date),ee=c=>{const b=y(c);return a.some(v=>y(v)===b)},de=c=>{const b=new Date;b.setHours(0,0,0,0);const v=c<b,j=c.getDay()===0;return!(c.getMonth()===F.getMonth())||v?null:j?"bg-red-800":ee(c)?"bg-green-800":null};if(N)return e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ye,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Caricamento calendario..."})]});if(ce)return e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-red-600 mb-4",children:ce}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:_,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Riprova"}),e.jsx("button",{onClick:()=>{O(null),D(!0),_()},className:"ml-2 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"Aggiorna"})]})]});const Ee=k(F);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(V,{className:"text-base font-medium mb-3 block text-center text-blue-800",children:"Seleziona la data in cui vorresti la consegna"}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 max-w-md mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("button",{onClick:()=>{const c=new Date(F);c.setMonth(F.getMonth()-1),Ae(c)},className:"p-2 rounded-xl border-2 border-blue-200 hover:bg-blue-50 transition-colors",children:e.jsx(ss,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("h2",{className:"text-2xl font-bold text-blue-800",children:[ne(F)," ",F.getFullYear()]}),e.jsx("button",{onClick:()=>{const c=new Date(F);c.setMonth(F.getMonth()+1),Ae(c)},className:"p-2 rounded-xl border-2 border-blue-200 hover:bg-blue-50 transition-colors",children:e.jsx(as,{className:"h-5 w-5 text-blue-600"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:q().map(c=>e.jsx("div",{className:"text-center text-sm font-medium text-gray-600 py-2",children:c},c))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:Ee.map((c,b)=>{const v=c.getMonth()===F.getMonth(),j=f&&y(f)===y(c),T=M(c),W=new Date;W.setHours(0,0,0,0);const Y=c.getTime()===W.getTime(),oe=c.getDay()===0,ge=de(c);return e.jsxs("button",{onClick:()=>{!T&&v&&pe(c)},disabled:T||!v,className:`
                    relative h-12 w-12 rounded-xl text-sm font-medium transition-all duration-200
                    ${v?j?"bg-green-600 text-white shadow-lg transform scale-105":T?"text-gray-400 cursor-not-allowed":"text-blue-800 hover:bg-gray-100 cursor-pointer":"text-gray-300 cursor-default"}
                    ${Y&&!j?"bg-gray-200 font-bold":""}
                  `,children:[e.jsx("span",{className:"relative z-10",children:c.getDate()}),ge&&e.jsx("div",{className:`absolute bottom-1 left-1/2 transform -translate-x-1/2 w-6 h-1 rounded-full ${ge}`}),T&&!oe&&v&&e.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-red-500 font-bold text-lg z-20",children:"×"})]},b)})})]})]}),f&&e.jsxs("div",{id:"time-slots-section",children:[e.jsx(V,{className:"text-base font-medium mb-3 block text-center text-blue-800",children:"Seleziona la Fascia Oraria"}),U?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(ye,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Caricamento fasce orarie..."})]}):e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:H.filter(c=>f&&f.getDay()===6?c!=="14:00 - 15:00"&&c!=="15:00 - 16:00":!0).map((c,b)=>{const v=C.includes(c),j=t.deliveryTimeSlot===c;return e.jsxs("button",{type:"button",onClick:()=>v?h(c):null,disabled:!v,className:`
                      px-3 py-2 rounded-md border-2 text-sm font-bold transition-colors flex flex-col items-center justify-center relative min-h-[60px]
                      ${v?j?"cursor-pointer":"cursor-pointer hover:opacity-80 bg-white":"cursor-not-allowed bg-white"}
                    `,style:{borderColor:v?j?"#3F691D":"#1B5AAB":"#A40800",backgroundColor:j?"#3F691D":"white",color:j?"white":v?"#1B5AAB":"#A40800"},children:[e.jsx("span",{className:"font-bold",children:c}),j?e.jsx("span",{className:"text-white font-bold text-lg mt-1",children:"✓"}):v?e.jsx("span",{className:"font-bold text-xs mt-1",style:{color:"#1B5AAB"},children:"DISPONIBILE"}):e.jsx("span",{className:"font-bold text-xs mt-1",style:{color:"#A40800"},children:"AL COMPLETO"})]},b)})})]})]})};/*!
 * react-paypal-js v8.8.3 (2025-04-11T19:50:46.506Z)
 * Copyright 2020-present, PayPal, Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var ie;(function(t){t.INITIAL="initial",t.PENDING="pending",t.REJECTED="rejected",t.RESOLVED="resolved"})(ie||(ie={}));var je;(function(t){t.LOADING_STATUS="setLoadingStatus",t.RESET_OPTIONS="resetOptions",t.SET_BRAINTREE_INSTANCE="braintreeInstance"})(je||(je={}));var Ct;(function(t){t.NUMBER="number",t.CVV="cvv",t.EXPIRATION_DATE="expirationDate",t.EXPIRATION_MONTH="expirationMonth",t.EXPIRATION_YEAR="expirationYear",t.POSTAL_CODE="postalCode"})(Ct||(Ct={}));var $=function(){return $=Object.assign||function(r){for(var i,o=1,u=arguments.length;o<u;o++){i=arguments[o];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(r[a]=i[a])}return r},$.apply(this,arguments)};function Dt(t,r){var i={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&r.indexOf(o)<0&&(i[o]=t[o]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var u=0,o=Object.getOwnPropertySymbols(t);u<o.length;u++)r.indexOf(o[u])<0&&Object.prototype.propertyIsEnumerable.call(t,o[u])&&(i[o[u]]=t[o[u]]);return i}function St(t,r,i){if(i||arguments.length===2)for(var o=0,u=r.length,a;o<u;o++)(a||!(o in r))&&(a||(a=Array.prototype.slice.call(r,0,o)),a[o]=r[o]);return t.concat(a||Array.prototype.slice.call(r))}var Te="data-react-paypal-script-id",we={DATA_CLIENT_TOKEN:"dataClientToken",DATA_JS_SDK_LIBRARY:"dataJsSdkLibrary",DATA_LIBRARY_VALUE:"react-paypal-js",DATA_NAMESPACE:"dataNamespace",DATA_SDK_INTEGRATION_SOURCE:"dataSdkIntegrationSource",DATA_USER_ID_TOKEN:"dataUserIdToken"},Bs="Failed to load the PayPal JS SDK script.",Pt="paypal",Os="usePayPalScriptReducer must be used within a PayPalScriptProvider";function ks(t){return t===void 0&&(t=Pt),window[t]}function Rs(t){for(var r="",i=0;i<t.length;i++){var o=t[i].charCodeAt(0)*i;t[i+1]&&(o+=t[i+1].charCodeAt(0)*(i-1)),r+=String.fromCharCode(97+Math.abs(o)%26)}return r}function Ms(t){var r=t.reactComponentName,i=t.sdkComponentKey,o=t.sdkRequestedComponents,u=o===void 0?"":o,a=t.sdkDataNamespace,p=a===void 0?Pt:a,f=i.charAt(0).toUpperCase().concat(i.substring(1)),E="Unable to render <".concat(r," /> because window.").concat(p,".").concat(f," is undefined."),C=typeof u=="string"?u:u.join(",");if(!C.includes(i)){var A=[C,i].filter(Boolean).join();E+=`
To fix the issue, add '`.concat(i,"' to the list of components passed to the parent PayPalScriptProvider:")+"\n`<PayPalScriptProvider options={{ components: '".concat(A,"'}}>`.")}return E}function Tt(t){var r=t,i=Te;r[i];var o=Dt(r,[i+""]);return"react-paypal-js-".concat(Rs(JSON.stringify(o)))}function Fs(t){var r=self.document.querySelector("script[".concat(Te,'="').concat(t,'"]'));r!=null&&r.parentNode&&r.parentNode.removeChild(r)}function Ls(t,r){var i,o;switch(r.type){case je.LOADING_STATUS:return typeof r.value=="object"?$($({},t),{loadingStatus:r.value.state,loadingStatusErrorMessage:r.value.message}):$($({},t),{loadingStatus:r.value});case je.RESET_OPTIONS:return Fs(t.options[Te]),$($({},t),{loadingStatus:ie.PENDING,options:$($((i={},i[we.DATA_SDK_INTEGRATION_SOURCE]=we.DATA_LIBRARY_VALUE,i),r.value),(o={},o[Te]="".concat(Tt(r.value)),o))});case je.SET_BRAINTREE_INSTANCE:return $($({},t),{braintreePayPalCheckoutInstance:r.value});default:return t}}var _t=m.createContext(null);function Us(t){if(typeof(t==null?void 0:t.dispatch)=="function"&&t.dispatch.length!==0)return t;throw new Error(Os)}function $s(){var t=Us(m.useContext(_t)),r=$($({},t),{isInitial:t.loadingStatus===ie.INITIAL,isPending:t.loadingStatus===ie.PENDING,isResolved:t.loadingStatus===ie.RESOLVED,isRejected:t.loadingStatus===ie.REJECTED});return[r,t.dispatch]}m.createContext({});function qs(t){var r=m.useRef(new Proxy({},{get:function(i,o,u){return typeof i[o]=="function"?function(){for(var a=[],p=0;p<arguments.length;p++)a[p]=arguments[p];return i[o].apply(i,a)}:Reflect.get(i,o,u)}}));return r.current=Object.assign(r.current,t),r.current}var Ge=function(t){var r,i=t.className,o=i===void 0?"":i,u=t.disabled,a=u===void 0?!1:u,p=t.children,f=t.forceReRender,E=f===void 0?[]:f,C=Dt(t,["className","disabled","children","forceReRender"]),A=a?{opacity:.38}:{},N="".concat(o," ").concat(a?"paypal-buttons-disabled":"").trim(),D=m.useRef(null),U=m.useRef(null),K=qs(C),ce=$s()[0],O=ce.isResolved,H=ce.options,y=m.useState(null),_=y[0],he=y[1],pe=m.useState(!0),h=pe[0],M=pe[1],ne=m.useState(null),q=ne[1];function k(){U.current!==null&&U.current.close().catch(function(){})}return!((r=U.current)===null||r===void 0)&&r.updateProps&&U.current.updateProps({message:C.message}),m.useEffect(function(){if(O===!1)return k;var F=ks(H.dataNamespace);if(F===void 0||F.Buttons===void 0)return q(function(){throw new Error(Ms({reactComponentName:Ge.displayName,sdkComponentKey:"buttons",sdkRequestedComponents:H.components,sdkDataNamespace:H[we.DATA_NAMESPACE]}))}),k;var Ae=function(ee,de){he(de),typeof C.onInit=="function"&&C.onInit(ee,de)};try{U.current=F.Buttons($($({},K),{onInit:Ae}))}catch(ee){return q(function(){throw new Error("Failed to render <PayPalButtons /> component. Failed to initialize:  ".concat(ee))})}return U.current.isEligible()===!1?(M(!1),k):(D.current&&U.current.render(D.current).catch(function(ee){D.current===null||D.current.children.length===0||q(function(){throw new Error("Failed to render <PayPalButtons /> component. ".concat(ee))})}),k)},St(St([O],E,!0),[C.fundingSource],!1)),m.useEffect(function(){_!==null&&(a===!0?_.disable().catch(function(){}):_.enable().catch(function(){}))},[a,_]),Pe.createElement(Pe.Fragment,null,h?Pe.createElement("div",{ref:D,style:A,className:N}):p)};Ge.displayName="PayPalButtons";function Gs(t,r){var i={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&r.indexOf(o)<0&&(i[o]=t[o]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var u=0,o=Object.getOwnPropertySymbols(t);u<o.length;u++)r.indexOf(o[u])<0&&Object.prototype.propertyIsEnumerable.call(t,o[u])&&(i[o[u]]=t[o[u]]);return i}function Zs(t,r){var i=document.querySelector('script[src="'.concat(t,'"]'));if(i===null)return null;var o=Bt(t,r),u=i.cloneNode();if(delete u.dataset.uidAuto,Object.keys(u.dataset).length!==Object.keys(o.dataset).length)return null;var a=!0;return Object.keys(u.dataset).forEach(function(p){u.dataset[p]!==o.dataset[p]&&(a=!1)}),a?i:null}function Js(t){var r=t.url,i=t.attributes,o=t.onSuccess,u=t.onError,a=Bt(r,i);a.onerror=u,a.onload=o,document.head.insertBefore(a,document.head.firstElementChild)}function Ws(t){var r=t.sdkBaseUrl,i=t.environment,o=Gs(t,["sdkBaseUrl","environment"]),u=r||Hs(i),a=o,p=Object.keys(a).filter(function(C){return typeof a[C]<"u"&&a[C]!==null&&a[C]!==""}).reduce(function(C,A){var N=a[A].toString();return A=Ks(A),A.substring(0,4)==="data"||A==="crossorigin"?C.attributes[A]=N:C.queryParams[A]=N,C},{queryParams:{},attributes:{}}),f=p.queryParams,E=p.attributes;return f["merchant-id"]&&f["merchant-id"].indexOf(",")!==-1&&(E["data-merchant-id"]=f["merchant-id"],f["merchant-id"]="*"),{url:"".concat(u,"?").concat(Vs(f)),attributes:E}}function Ks(t){var r=function(i,o){return(o?"-":"")+i.toLowerCase()};return t.replace(/[A-Z]+(?![a-z])|[A-Z]/g,r)}function Vs(t){var r="";return Object.keys(t).forEach(function(i){r.length!==0&&(r+="&"),r+=i+"="+t[i]}),r}function Hs(t){return t==="sandbox"?"https://www.sandbox.paypal.com/sdk/js":"https://www.paypal.com/sdk/js"}function Bt(t,r){r===void 0&&(r={});var i=document.createElement("script");return i.src=t,Object.keys(r).forEach(function(o){i.setAttribute(o,r[o]),o==="data-csp-nonce"&&i.setAttribute("nonce",r["data-csp-nonce"])}),i}function Ys(t,r){if(r===void 0&&(r=Promise),Ot(t,r),typeof document>"u")return r.resolve(null);var i=Ws(t),o=i.url,u=i.attributes,a=u["data-namespace"]||"paypal",p=wt(a);return u["data-js-sdk-library"]||(u["data-js-sdk-library"]="paypal-js"),Zs(o,u)&&p?r.resolve(p):Xs({url:o,attributes:u},r).then(function(){var f=wt(a);if(f)return f;throw new Error("The window.".concat(a," global variable is not available."))})}function Xs(t,r){r===void 0&&(r=Promise),Ot(t,r);var i=t.url,o=t.attributes;if(typeof i!="string"||i.length===0)throw new Error("Invalid url.");if(typeof o<"u"&&typeof o!="object")throw new Error("Expected attributes to be an object.");return new r(function(u,a){if(typeof document>"u")return u();Js({url:i,attributes:o,onSuccess:function(){return u()},onError:function(){var p=new Error('The script "'.concat(i,'" failed to load. Check the HTTP status code and response body in DevTools to learn more.'));return a(p)}})})}function wt(t){return window[t]}function Ot(t,r){if(typeof t!="object"||t===null)throw new Error("Expected an options object.");var i=t.environment;if(i&&i!=="production"&&i!=="sandbox")throw new Error('The `environment` option must be either "production" or "sandbox".');if(typeof r<"u"&&typeof r!="function")throw new Error("Expected PromisePonyfill to be a function.")}var Qs=function(t){var r,i=t.options,o=i===void 0?{clientId:"test"}:i,u=t.children,a=t.deferLoading,p=a===void 0?!1:a,f=m.useReducer(Ls,{options:$($({},o),(r={},r[we.DATA_JS_SDK_LIBRARY]=we.DATA_LIBRARY_VALUE,r[we.DATA_SDK_INTEGRATION_SOURCE]=we.DATA_LIBRARY_VALUE,r[Te]="".concat(Tt(o)),r)),loadingStatus:p?ie.INITIAL:ie.PENDING}),E=f[0],C=f[1];return m.useEffect(function(){if(p===!1&&E.loadingStatus===ie.INITIAL)return C({type:je.LOADING_STATUS,value:ie.PENDING});if(E.loadingStatus===ie.PENDING){var A=!0;return Ys(E.options).then(function(){A&&C({type:je.LOADING_STATUS,value:ie.RESOLVED})}).catch(function(N){console.error("".concat(Bs," ").concat(N)),A&&C({type:je.LOADING_STATUS,value:{state:ie.REJECTED,message:String(N)}})}),function(){A=!1}}},[E.options,p,E.loadingStatus]),Pe.createElement(_t.Provider,{value:$($({},E),{dispatch:C})},u)};function Et(){}m.createContext({cardFieldsForm:null,fields:{},registerField:Et,unregisterField:Et});const ea=({amount:t,currency:r="EUR",onSuccess:i,onError:o,onCancel:u})=>{const p={"client-id":"AYGtIXY3WWCFKCHrizRHKS0TOSWLD8ekRyb4ZHnE9WBNj1lennIFBLqRwIC9C-c0KP57tA2dXzWouLk_",currency:r,intent:"capture","disable-funding":"credit,card,mybank","data-page-type":"checkout"},f=(N,D)=>D.order.create({purchase_units:[{amount:{currency_code:r,value:t}}]}),E=(N,D)=>D.order.capture().then(U=>{I.success("Pagamento completato con successo!"),i(U)}),C=N=>{console.error("PayPal Checkout onError",N),I.error("Errore durante il pagamento PayPal"),o(N)},A=()=>{I.info("Pagamento PayPal annullato"),u&&u()};return e.jsx(Qs,{options:p,children:e.jsx("div",{className:"paypal-container relative z-10",children:e.jsx(Ge,{style:{layout:"vertical",color:"blue",shape:"rect",label:"paypal",height:40},createOrder:f,onApprove:E,onError:C,onCancel:A,forceReRender:[t,r]})})})},ta=xs("pk_test_q2T6zSXCsZgSDBoczp5ESl9I"),sa=({amount:t,currency:r,onSuccess:i,onError:o})=>{const u=ys(),a=vs(),[p,f]=m.useState(!1),{authState:E}=It(),C=async A=>{var D;if(A.preventDefault(),!u||!a)return;const N=a.getElement(ft);if(N){f(!0);try{const U=E.user?`${E.user.first_name} ${E.user.last_name}`.trim():"Cliente Imperatore Bevande",{error:K,paymentMethod:ce}=await u.createPaymentMethod({type:"card",card:N,billing_details:{name:U,email:((D=E.user)==null?void 0:D.email)||void 0}});K?(console.error("Errore validazione carta:",K),I.error("Errore nella validazione della carta: "+K.message),o(K)):(console.log("Metodo di pagamento creato:",ce),I.success("Carta validata con successo!"),i(ce))}catch(U){console.error("Errore:",U),I.error("Errore durante la validazione della carta"),o(U)}finally{f(!1)}}};return e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsx("div",{className:"p-4 border border-gray-300 rounded-lg",children:e.jsx(ft,{options:{hidePostalCode:!0,style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146"}}}})}),e.jsx("button",{type:"submit",disabled:!u||p,className:"w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:p?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 animate-spin mr-2"}),"Elaborazione..."]}):`Paga €${t}`})]})},aa=({amount:t,currency:r="EUR",onSuccess:i,onError:o})=>e.jsx(fs,{stripe:ta,children:e.jsx(sa,{amount:t,currency:r,onSuccess:i,onError:o})}),ra=t=>{switch(t.id){case"cod":return"💶 Contanti o carta di credito alla consegna";case"stripe":return"Credit Card";case"paypal":return"PayPal";case"satispay":return"Satispay";case"bacs":return"Bank Transfer";default:return t.title}},$e=t=>{switch(t.id){case"cod":return"I nostri collaboratori durante la consegna del vostro ordine, saranno muniti di contanti o con POS per agevolarvi nel pagamento.";case"stripe":return"Paga in modo sicuro con la tua carta di credito. I tuoi dati sono protetti con crittografia SSL.";case"paypal":return"Paga facilmente e in sicurezza con il tuo account PayPal.";default:return t.description}},ia=t=>{switch(t){case"cod":return"💶";case"stripe":return"💳";case"paypal":return"🅿️";case"satispay":return"📱";case"bacs":return"🏦";default:return"💳"}},na=({paymentGatewaysLoading:t,filteredPaymentGateways:r,paymentMethod:i,setPaymentMethod:o,expandedPaymentDetails:u,setExpandedPaymentDetails:a,orderTotal:p="0",onPayPalSuccess:f,onPayPalError:E,onStripeSuccess:C,onStripeError:A})=>t?e.jsx("div",{className:"space-y-4",children:e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ye,{className:"w-6 h-6 animate-spin"})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Scegli l'opzione di pagamento:"}),e.jsx("div",{className:"space-y-3",children:r.map(N=>{const D=i===N.id;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:`
                  flex items-center p-4 border-2 rounded-lg cursor-pointer transition-all duration-200
                  ${D?"border-blue-500 bg-blue-50":"border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50"}
                `,onClick:()=>{console.log("Payment method clicked:",N.id),o(N.id)},children:[e.jsx("div",{className:"flex items-center mr-4",children:e.jsx("div",{className:`
                    w-5 h-5 rounded-full border-2 flex items-center justify-center
                    ${D?"border-blue-500 bg-blue-500":"border-gray-300 bg-white"}
                  `,children:D&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-white"})})}),e.jsx("div",{className:"flex items-center mr-3",children:N.id==="paypal"?e.jsx("span",{className:"text-2xl",children:"🅿️"}):N.id==="cod"?e.jsx("span",{className:"text-2xl",children:"💶"}):N.id==="stripe"?e.jsx("span",{className:"text-2xl",children:"💳"}):e.jsx("span",{className:"text-2xl",children:ia(N.id)})}),e.jsx("div",{className:"flex-1",children:e.jsx("span",{className:"text-base font-medium text-gray-900",children:ra(N)})})]}),D&&N.id==="paypal"&&f&&E&&e.jsxs("div",{className:"ml-9 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:$e(N)}),e.jsx(ea,{amount:p,currency:"EUR",onSuccess:f,onError:E})]}),D&&N.id==="stripe"&&C&&A&&e.jsxs("div",{className:"ml-9 p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:$e(N)}),e.jsx(aa,{amount:p,currency:"EUR",onSuccess:C,onError:A})]}),D&&N.id!=="paypal"&&N.id!=="stripe"&&e.jsx("div",{className:"ml-9 p-4 bg-gray-50 rounded-lg border border-gray-200",children:e.jsx("p",{className:"text-sm text-gray-600",children:$e(N)})})]},N.id)})})]}),zt=({customer:t,onZoneDetected:r})=>{var f,E,C,A,N,D,U,K;const[i,o]=m.useState(null),[u,a]=m.useState(!0);if(m.useEffect(()=>{const ce=async()=>{var O,H,y,_,he,pe,h,M;a(!0);try{const ne={city:((O=t.shipping)==null?void 0:O.city)||((H=t.billing)==null?void 0:H.city)||"",province:((y=t.shipping)==null?void 0:y.state)||((_=t.billing)==null?void 0:_.state)||"",postalCode:((he=t.shipping)==null?void 0:he.postcode)||((pe=t.billing)==null?void 0:pe.postcode)||"",address:((h=t.shipping)==null?void 0:h.address_1)||((M=t.billing)==null?void 0:M.address_1)||""};let q=fe(ne);if(!q&&ne.address&&ne.city)try{const k=await qe(ne);k&&(q=hs(k.lat,k.lng))}catch(k){console.warn("Errore nella geocodifica:",k)}o(q),r==null||r(q)}catch(ne){console.error("Errore nella determinazione della zona:",ne)}finally{a(!1)}};t!=null&&t.shipping||t!=null&&t.billing?ce():a(!1)},[t]),u)return e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(ye,{className:"w-3 h-3 mr-2 animate-spin"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Determinazione zona..."})]});const p=`${((f=t.shipping)==null?void 0:f.address_1)||((E=t.billing)==null?void 0:E.address_1)}, ${((C=t.shipping)==null?void 0:C.city)||((A=t.billing)==null?void 0:A.city)}, ${((N=t.shipping)==null?void 0:N.state)||((D=t.billing)==null?void 0:D.state)} ${((U=t.shipping)==null?void 0:U.postcode)||((K=t.billing)==null?void 0:K.postcode)}`;return i?e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2",style:{backgroundColor:i.color}}),e.jsxs("span",{className:"text-xs font-medium",style:{color:i.color},children:[i.name," - Fasce orarie ottimizzate per questa zona"]})]}):e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2 bg-gray-400"}),e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:["Zona non identificata - Debug: ",p]})]})},Ca=()=>{var tt,st,at,rt,it;const{state:t,dispatch:r}=us(),i=Ts(),o=Ds(),u=ws(),{authState:a}=It();console.log("=== CHECKOUT COMPONENT DEBUG ==="),console.log("authState:",a),console.log("authState.isAuthenticated:",a==null?void 0:a.isAuthenticated),console.log("authState.user:",a==null?void 0:a.user),console.log("authState.user.id:",(tt=a==null?void 0:a.user)==null?void 0:tt.id),console.log("authState.user.email:",(st=a==null?void 0:a.user)==null?void 0:st.email);const[p,f]=m.useState(0),[E,C]=m.useState(!1),[A,N]=m.useState(!1),[D,U]=m.useState(!1),[K,ce]=m.useState({address:"",city:"",postalCode:"",province:""});m.useState(!1),m.useState(null);const[O,H]=m.useState([]),[y,_]=m.useState("main"),[he,pe]=m.useState(!1),[h,M]=m.useState({title:"",address:"",city:"",province:"",postalCode:""}),[ne,q]=m.useState(!1);m.useState("main");const[k,F]=m.useState(null),[Ae,ee]=m.useState(!1),[de,Ee]=m.useState({}),[c,b]=m.useState(!1),[v,j]=m.useState(null),[T,W]=m.useState({address:!1,city:!1,postalCode:!1,province:!1}),Y=[{id:0,name:"INDIRIZZO di CONSEGNA",icon:xe},{id:1,name:"DATA CONSEGNA",icon:mt},{id:2,name:"RIEPILOGO ORDINE",icon:is},{id:3,name:"TIPO di PAGAMENTO",icon:ns}],[oe,ge]=m.useState(!1);m.useState(!0);const te=(at=a==null?void 0:a.user)!=null&&at.id&&a.user.id>0?a.user.id:null,_e=!te&&!!((rt=a==null?void 0:a.user)!=null&&rt.email)&&!oe,{data:Ce,isLoading:Ze}=Es(((it=a==null?void 0:a.user)==null?void 0:it.email)||"",{enabled:_e&&!!(a!=null&&a.isAuthenticated),retry:!1,refetchOnWindowFocus:!1,refetchOnMount:!1}),B=m.useMemo(()=>(console.log("=== CALCULATING EFFECTIVE CUSTOMER ID ==="),console.log("authCustomerId:",te),console.log("customerByEmail:",Ce),te?(console.log("Using authCustomerId:",te),te):Ce&&Ce.length>0?(console.log("Using customerByEmail ID:",Ce[0].id),Ce[0].id):(console.log("No effective customer ID found"),null)),[te,Ce]),{data:s,isLoading:Je}=zs(B||0,{enabled:!!B&&B>0&&!!(a!=null&&a.isAuthenticated)});m.useEffect(()=>{console.log("=== CUSTOMER DATA DEBUG ==="),console.log("effectiveCustomerId:",B),console.log("customerLoading:",Je),console.log("customer:",s),console.log("customer?.id:",s==null?void 0:s.id),console.log("customer?.meta_data:",s==null?void 0:s.meta_data)},[B,Je,s]);const{data:Fe,isLoading:We}=Is(),kt=["cod","stripe","paypal","satispay","bacs"],Se=(Fe==null?void 0:Fe.filter(l=>kt.includes(l.id)))||[],[g,Be]=m.useState({firstName:"",lastName:"",email:"",phone:"",address:"",city:"",postalCode:"",province:"",orderNotes:"",deliveryDate:"",deliveryTimeSlot:""});m.useState(void 0);const[me,Ke]=m.useState(""),Ve=m.useCallback(l=>{Ke(l)},[]),[He,Oe]=m.useState(!1),[Rt,Mt]=m.useState(null);m.useEffect(()=>{a.isAuthenticated&&s?Be({firstName:s.first_name||"",lastName:s.last_name||"",email:s.email||"",phone:s.billing.phone||"",address:s.shipping.address_1||s.billing.address_1||"",city:s.shipping.city||s.billing.city||"",postalCode:s.shipping.postcode||s.billing.postcode||"",province:s.shipping.state||s.billing.state||"",orderNotes:"",deliveryDate:"",deliveryTimeSlot:""}):a.isAuthenticated||Be({firstName:"",lastName:"",email:"",phone:"",address:"",city:"",postalCode:"",province:"",orderNotes:"",deliveryDate:"",deliveryTimeSlot:""})},[a.isAuthenticated,s]);const Ft=async l=>await Promise.all(l.map(async x=>{const S=fe({city:x.city,province:x.province,postalCode:x.postalCode,coordinates:x.coordinates});return{...x,deliveryZone:S?{id:S.id,name:S.name,color:S.color}:null}}));m.useEffect(()=>{if(s&&s.meta_data){const l=s.meta_data.find(d=>d.key==="saved_addresses");if(l&&l.value)try{const d=JSON.parse(l.value);Ft(d).then(x=>{if(H(x),JSON.stringify(d)!==JSON.stringify(x)&&(console.log("Aggiornamento colori zone per indirizzi salvati"),B&&a.isAuthenticated&&s)){const z=((s==null?void 0:s.meta_data)||[]).filter(w=>w.key!=="saved_addresses");z.push({key:"saved_addresses",value:JSON.stringify(x)}),u.mutateAsync({id:B,customerData:{meta_data:z}}).catch(w=>{console.error("Errore nell'aggiornamento colori zone:",w)})}})}catch(d){console.error("Errore nel parsing degli indirizzi salvati:",d)}}},[s,B,a.isAuthenticated]),m.useEffect(()=>{(!_e||_e&&!Ze)&&ge(!0)},[_e,Ze]),m.useEffect(()=>{if(!me&&Se&&Se.length>0){const l=Se[0].id;Se.some(d=>d.id===l)&&Ve(l)}},[Se,me,Ve]);const ze=l=>{const{name:d,value:x}=l.target;d==="deliveryDate"||d==="deliveryTimeSlot"||Be(S=>({...S,[d]:x}))},Lt=(l,d)=>{Be(x=>({...x,deliveryDate:l,deliveryTimeSlot:d}))},ve=l=>{const{name:d,value:x}=l.target;M(S=>({...S,[d]:x})),de[d]&&Ee(S=>({...S,[d]:!1}))},Ut=()=>{const l={address:!h.address.trim(),city:!h.city.trim(),postalCode:!h.postalCode.trim(),province:!h.province.trim()};return W(l),!Object.values(l).some(d=>d)},Ye=async()=>{var w;if(!Ut()){I.error("Compila tutti i campi obbligatori");return}console.log("=== DEBUG SAVE ADDRESS ==="),console.log("authState.user.id:",(w=a.user)==null?void 0:w.id),console.log("authCustomerId:",te),console.log("customerByEmail:",Ce),console.log("effectiveCustomerId:",B),console.log("authState.isAuthenticated:",a.isAuthenticated),console.log("customer presente:",!!s),console.log("customer.id:",s==null?void 0:s.id);const l=B&&a.isAuthenticated&&s;console.log("Condizione API soddisfatta?",l),console.log("- effectiveCustomerId:",!!B),console.log("- authState.isAuthenticated:",!!a.isAuthenticated),console.log("- customer:",!!s);const d=await qe({address:h.address,city:h.city,province:h.province,postalCode:h.postalCode}),x=fe({city:h.city,province:h.province,postalCode:h.postalCode,coordinates:d?{lat:d.lat,lng:d.lng}:void 0}),S={id:Date.now(),title:h.title||`Indirizzo ${O.length+1}`,address:h.address,city:h.city,province:h.province,postalCode:h.postalCode,coordinates:d?{lat:d.lat,lng:d.lng}:void 0,deliveryZone:x?{id:x.id,name:x.name,color:x.color}:null};x?I.success(`Indirizzo assegnato alla ${x.name}`):I.warning("Zona di consegna non determinata automaticamente");const z=[...O,S];if(console.log("Indirizzi aggiornati da salvare:",z),B&&a.isAuthenticated&&s){console.log("Condizioni soddisfatte, procedo con il salvataggio API");try{ee(!0);const G=(s==null?void 0:s.meta_data)||[];console.log("Meta data esistenti:",G);const X=G.filter(Q=>Q.key!=="saved_addresses");X.push({key:"saved_addresses",value:JSON.stringify(z)}),console.log("Meta data da inviare:",X),console.log("Customer ID:",B);const Ne=await u.mutateAsync({id:B,customerData:{meta_data:X}});console.log("Risultato aggiornamento:",Ne),H(z),_(S.id.toString()),I.success("Indirizzo salvato nell'account!")}catch(G){console.error("Errore nel salvataggio indirizzo:",G),console.error("Dettagli errore:",JSON.stringify(G,null,2)),I.error("Errore nel salvataggio dell'indirizzo");return}finally{ee(!1)}}else console.log("Condizioni NON soddisfatte per API:"),console.log("- effectiveCustomerId:",B),console.log("- authState.isAuthenticated:",a.isAuthenticated),console.log("- customer presente:",!!s),console.log("Salvataggio solo locale"),H(z),_(S.id.toString()),I.success("Indirizzo salvato localmente!");pe(!1),M({title:"",address:"",city:"",province:"",postalCode:""})},$t=async l=>{const d=O.filter(x=>x.id.toString()!==l);if(console.log("=== DEBUG DELETE ADDRESS ==="),console.log("effectiveCustomerId:",B),console.log("authState.isAuthenticated:",a.isAuthenticated),console.log("customer:",s),console.log("Indirizzi dopo eliminazione:",d),y===l&&_("main"),B&&a.isAuthenticated&&s){console.log("Condizioni soddisfatte, procedo con eliminazione API");try{ee(!0);const x=(s==null?void 0:s.meta_data)||[];console.log("Meta data esistenti (delete):",x);const S=x.filter(w=>w.key!=="saved_addresses");S.push({key:"saved_addresses",value:JSON.stringify(d)}),console.log("Meta data da inviare (delete):",S);const z=await u.mutateAsync({id:B,customerData:{meta_data:S}});console.log("Risultato eliminazione:",z),H(d),I.success("Indirizzo eliminato!")}catch(x){console.error("Errore nell'eliminazione indirizzo:",x),console.error("Dettagli errore (delete):",JSON.stringify(x,null,2)),I.error("Errore nell'eliminazione dell'indirizzo");return}finally{ee(!1)}}else console.log("Condizioni NON soddisfatte per API eliminazione:"),console.log("- effectiveCustomerId:",B),console.log("- authState.isAuthenticated:",a.isAuthenticated),console.log("- customer presente:",!!s),console.log("Eliminazione solo locale"),H(d),I.success("Indirizzo eliminato localmente!")},qt=async(l,d)=>{let x={...d};if(d.city||d.province||d.postalCode||d.address){const z=O.find(w=>w.id.toString()===l);if(z){const w={address:d.address||z.address,city:d.city||z.city,province:d.province||z.province,postalCode:d.postalCode||z.postalCode},G=await qe(w),X=fe({...w,coordinates:G?{lat:G.lat,lng:G.lng}:void 0});x.deliveryZone=X?{id:X.id,name:X.name,color:X.color}:null,G&&(x.coordinates={lat:G.lat,lng:G.lng}),X?I.success(`Indirizzo aggiornato e assegnato alla ${X.name}`):I.warning("Zona di consegna non determinata per l'indirizzo aggiornato")}}const S=O.map(z=>z.id.toString()===l?{...z,...x}:z);if(H(S),B&&a.isAuthenticated&&s)try{const w=((s==null?void 0:s.meta_data)||[]).filter(G=>G.key!=="saved_addresses");w.push({key:"saved_addresses",value:JSON.stringify(S)}),await u.mutateAsync({id:B,customerData:{meta_data:w}}),I.success("Indirizzo aggiornato!")}catch(z){console.error("Errore nell'aggiornamento indirizzo:",z),I.error("Errore nell'aggiornamento dell'indirizzo")}},be=l=>{switch(l){case 0:return y==="main"?g.firstName&&g.lastName&&g.email&&g.phone&&g.address&&g.city&&g.postalCode&&g.province:O.find(x=>x.id&&x.id.toString()===y)!==void 0;case 1:return g.deliveryDate!==""&&g.deliveryTimeSlot!=="";case 2:return!0;case 3:return me!=="";default:return!1}},Gt=()=>{var l,d,x,S,z,w,G,X,Ne,Q,ke,nt,ot,lt,ct,dt;switch(p){case 0:return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center",style:{color:"#1B5AAB"},children:[e.jsx(xe,{className:"w-5 h-5 mr-2"}),"Seleziona Indirizzo di Spedizione"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s&&e.jsxs("div",{className:`relative border-2 p-5 rounded-xl cursor-pointer transition-all hover:shadow-md ${y==="main"?"border-green-500 bg-green-50 shadow-sm":"hover:border-blue-300"}`,style:{borderColor:y==="main"?"#10b981":(()=>{var P,R,Z,J,se,ae,ue,L;const n=fe({city:((P=s.shipping)==null?void 0:P.city)||((R=s.billing)==null?void 0:R.city)||"",province:((Z=s.shipping)==null?void 0:Z.state)||((J=s.billing)==null?void 0:J.state)||"",postalCode:((se=s.shipping)==null?void 0:se.postcode)||((ae=s.billing)==null?void 0:ae.postcode)||"",address:((ue=s.shipping)==null?void 0:ue.address_1)||((L=s.billing)==null?void 0:L.address_1)||""});return(n==null?void 0:n.color)||"#d1d5db"})()},onClick:()=>_("main"),children:[e.jsx(le,{variant:"ghost",size:"sm",onClick:n=>{var P,R,Z,J,se,ae,ue,L;n.stopPropagation(),F("main"),M({title:"Indirizzo Principale",address:((P=s.shipping)==null?void 0:P.address_1)||((R=s.billing)==null?void 0:R.address_1)||"",city:((Z=s.shipping)==null?void 0:Z.city)||((J=s.billing)==null?void 0:J.city)||"",province:((se=s.shipping)==null?void 0:se.state)||((ae=s.billing)==null?void 0:ae.state)||"",postalCode:((ue=s.shipping)==null?void 0:ue.postcode)||((L=s.billing)==null?void 0:L.postcode)||""}),q(!0)},className:"absolute top-3 right-3 text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-2 h-8 w-8",children:e.jsx(De,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex items-start space-x-3 pr-10",children:[e.jsx("input",{type:"radio",name:"selectedAddress",value:"main",checked:y==="main",onChange:()=>_("main"),className:"mt-1 text-green-600 focus:ring-green-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(ut,{className:"w-5 h-5 mr-2 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-blue-700 text-base",children:"Indirizzo Principale Account"}),y==="main"&&e.jsx(Me,{className:"w-5 h-5 ml-2 text-green-600"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsx("p",{className:"text-gray-700 font-medium",children:((l=s.shipping)==null?void 0:l.address_1)||((d=s.billing)==null?void 0:d.address_1)}),e.jsxs("p",{children:[((x=s.shipping)==null?void 0:x.city)||((S=s.billing)==null?void 0:S.city),", ",((z=s.shipping)==null?void 0:z.state)||((w=s.billing)==null?void 0:w.state)," ",((G=s.shipping)==null?void 0:G.postcode)||((X=s.billing)==null?void 0:X.postcode)]}),e.jsx(zt,{customer:s,onZoneDetected:j})]})]})]})]}),O.map(n=>{var P;return e.jsxs("div",{className:`relative border-2 p-5 rounded-xl cursor-pointer transition-all hover:shadow-md ${y===n.id.toString()?"border-green-500 bg-green-50 shadow-sm":"hover:border-blue-300"}`,style:{borderColor:y===n.id.toString()?"#10b981":((P=n.deliveryZone)==null?void 0:P.color)||"#d1d5db"},onClick:()=>_(n.id.toString()),children:[e.jsxs("div",{className:"absolute top-3 right-3 flex items-center gap-1",children:[e.jsx(le,{variant:"ghost",size:"sm",onClick:R=>{R.stopPropagation(),F(n.id),M({title:n.title,address:n.address,city:n.city,province:n.province,postalCode:n.postalCode}),q(!0)},className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-2 h-8 w-8",children:e.jsx(De,{className:"w-4 h-4"})}),e.jsx(le,{variant:"ghost",size:"sm",onClick:R=>{R.stopPropagation(),$t(n.id.toString())},className:"text-red-500 hover:text-red-700 hover:bg-red-50 p-2 h-8 w-8",children:"✕"})]}),e.jsxs("div",{className:"flex items-start space-x-3 pr-16",children:[e.jsx("input",{type:"radio",name:"selectedAddress",value:n.id,checked:y===n.id.toString(),onChange:()=>_(n.id.toString()),className:"mt-1 text-green-600 focus:ring-green-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(xe,{className:"w-5 h-5 mr-2 text-gray-600"}),e.jsx("h4",{className:"font-semibold text-gray-800 text-base",children:n.title}),y===n.id.toString()&&e.jsx(Me,{className:"w-5 h-5 ml-2 text-green-600"})]}),e.jsxs("div",{className:"space-y-1 text-sm text-gray-600",children:[e.jsx("p",{className:"text-gray-700 font-medium",children:n.address}),e.jsxs("p",{children:[n.city,", ",n.province," ",n.postalCode]})]})]})]})]},n.id)}),he?e.jsxs("div",{className:"border-2 border-blue-300 bg-blue-50 p-4 rounded-lg",children:[e.jsxs("h4",{className:"font-semibold text-blue-700 mb-3 flex items-center",children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Nuovo Indirizzo"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"newTitle",className:"text-sm font-medium",children:"Titolo (es. Casa, Ufficio)"}),e.jsx(re,{id:"newTitle",name:"title",value:h.title,onChange:ve,placeholder:"Casa",className:"mt-1"})]}),e.jsx("div",{children:e.jsx(At,{label:"Indirizzo",placeholder:"Inizia a digitare l'indirizzo...",value:h.address,onChange:n=>{M({...h,address:n})},onAddressSelect:n=>{M({...h,address:n.address,city:n.city,province:n.province,postalCode:n.postalCode})},className:"mt-1",required:!0})}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"newCity",className:"text-sm font-medium",children:"Città *"}),e.jsx(re,{id:"newCity",name:"city",value:h.city,onChange:ve,placeholder:"Città o Paese",className:"mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"newProvince",className:"text-sm font-medium",children:"Provincia *"}),e.jsx(re,{id:"newProvince",name:"province",value:h.province,onChange:ve,placeholder:"Inserisci la Provincia",className:"mt-1",required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"newPostalCode",className:"text-sm font-medium",children:"CAP *"}),e.jsx(re,{id:"newPostalCode",name:"postalCode",value:h.postalCode,onChange:ve,placeholder:"Inserisci il CAP",className:"mt-1",required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-sm font-medium",children:"Paese"}),e.jsx(re,{value:"IT",className:"mt-1 bg-gray-100",readOnly:!0})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(le,{variant:"outline",onClick:()=>{pe(!1),M({title:"",address:"",city:"",province:"",postalCode:""})},className:"flex-1",children:"Annulla"}),e.jsx(le,{onClick:Ye,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white",children:"Salva Indirizzo"})]})]})]}):e.jsxs("button",{onClick:()=>{F(null),M({title:"",address:"",city:"",province:"",postalCode:""}),q(!0)},className:"w-full border-2 border-dashed border-gray-300 bg-gray-50 hover:bg-gray-100 text-gray-600 py-6 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(xe,{className:"w-5 h-5 mr-2"}),"➕ Aggiungi un nuovo indirizzo"]})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center",style:{color:"#1B5AAB"},children:[e.jsx(ms,{className:"w-5 h-5 mr-2"}),"Dati Personali"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"firstName",children:"Nome *"}),e.jsx(re,{id:"firstName",name:"firstName",value:g.firstName,onChange:ze,required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"lastName",children:"Cognome *"}),e.jsx(re,{id:"lastName",name:"lastName",value:g.lastName,onChange:ze,required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"email",children:"Email *"}),e.jsx(re,{id:"email",name:"email",type:"email",value:g.email,onChange:ze,required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"phone",children:"Telefono *"}),e.jsx(re,{id:"phone",name:"phone",value:g.phone,onChange:ze,required:!0})]})]}),!1]})]});case 1:const ts=()=>{var n,P,R,Z,J,se,ae,ue;if(y==="main"&&s){if(v)return console.log("✅ Usando zona determinata dal CheckoutMainAddressZone:",v.name),v;const L={city:((n=s.shipping)==null?void 0:n.city)||((P=s.billing)==null?void 0:P.city)||"",province:((R=s.shipping)==null?void 0:R.state)||((Z=s.billing)==null?void 0:Z.state)||"",postalCode:((J=s.shipping)==null?void 0:J.postcode)||((se=s.billing)==null?void 0:se.postcode)||"",address:((ae=s.shipping)==null?void 0:ae.address_1)||((ue=s.billing)==null?void 0:ue.address_1)||""};let Re=fe(L);return!Re&&L.address&&L.city&&console.log("⚠️ Zona non trovata per indirizzo principale, sarà determinata asincronamente"),Re}else{const L=O.find(Re=>Re.id.toString()===y);if(L&&L.deliveryZone)return xt(L.deliveryZone.id);if(L)return fe({city:L.city,province:L.province,postalCode:L.postalCode,address:L.address})}return null};return e.jsx(_s,{formData:{deliveryDate:g.deliveryDate,deliveryTimeSlot:g.deliveryTimeSlot},onDateTimeChange:Lt,deliveryZone:ts()});case 2:return e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"lg:grid lg:grid-cols-5 lg:gap-8 space-y-6 lg:space-y-0",children:[e.jsxs("div",{className:"lg:col-span-3 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center justify-between",style:{color:"#1B5AAB"},children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(os,{className:"w-5 h-5 mr-2"}),"Seleziona Indirizzo di Spedizione"]}),e.jsxs(le,{variant:"outline",size:"sm",onClick:()=>f(0),className:"text-xs px-3 py-1 border-[#1B5AAB] text-[#1B5AAB] hover:bg-[#1B5AAB] hover:text-white",children:[e.jsx(xe,{className:"w-3 h-3 mr-1"}),"Aggiungi Indirizzo"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3",children:[s&&e.jsxs("div",{className:`relative p-4 rounded-lg transition hover:shadow-md min-h-[140px] border-2 cursor-pointer ${y==="main"?"border-green-500 bg-green-50":"hover:border-blue-300"}`,style:{borderColor:y==="main"?"#10b981":(()=>{var P,R,Z,J,se,ae;const n=fe({city:((P=s.shipping)==null?void 0:P.city)||((R=s.billing)==null?void 0:R.city)||"",province:((Z=s.shipping)==null?void 0:Z.state)||((J=s.billing)==null?void 0:J.state)||"",postalCode:((se=s.shipping)==null?void 0:se.postcode)||((ae=s.billing)==null?void 0:ae.postcode)||""});return(n==null?void 0:n.color)||"#d1d5db"})()},onClick:()=>_("main"),children:[e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("button",{onClick:n=>{var P,R,Z,J,se,ae,ue,L;n.stopPropagation(),F("main"),M({title:"Indirizzo Principale",address:((P=s.shipping)==null?void 0:P.address_1)||((R=s.billing)==null?void 0:R.address_1)||"",city:((Z=s.shipping)==null?void 0:Z.city)||((J=s.billing)==null?void 0:J.city)||"",province:((se=s.shipping)==null?void 0:se.state)||((ae=s.billing)==null?void 0:ae.state)||"",postalCode:((ue=s.shipping)==null?void 0:ue.postcode)||((L=s.billing)==null?void 0:L.postcode)||""}),q(!0)},className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 transition",title:"Modifica indirizzo",children:e.jsx(De,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"selectedAddressReview",value:"main",checked:y==="main",onChange:()=>_("main"),className:"mr-3 text-green-600"}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-base font-semibold text-blue-800 mb-1 flex items-center",children:[e.jsx(ut,{className:"w-4 h-4 mr-1"}),"Indirizzo dell'account"]}),e.jsxs("div",{className:"space-y-1 mt-1 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Via:"})," ",((Ne=s.shipping)==null?void 0:Ne.address_1)||((Q=s.billing)==null?void 0:Q.address_1)]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Città:"})," ",((ke=s.shipping)==null?void 0:ke.city)||((nt=s.billing)==null?void 0:nt.city),", ",((ot=s.shipping)==null?void 0:ot.state)||((lt=s.billing)==null?void 0:lt.state)," ",((ct=s.shipping)==null?void 0:ct.postcode)||((dt=s.billing)==null?void 0:dt.postcode)]}),e.jsx(zt,{customer:s,onZoneDetected:j})]})]})]}),y==="main"&&e.jsx("div",{className:"absolute bottom-2 right-2 text-green-600",children:e.jsx(Me,{className:"w-5 h-5"})})]}),O.map(n=>{var P;return e.jsxs("div",{className:`relative p-4 rounded-lg transition hover:shadow-md min-h-[140px] border-2 cursor-pointer ${y===n.id.toString()?"border-green-500 bg-green-50":"hover:border-blue-300"}`,style:{borderColor:y===n.id.toString()?"#10b981":((P=n.deliveryZone)==null?void 0:P.color)||"#d1d5db"},onClick:()=>_(n.id.toString()),children:[e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx("button",{onClick:R=>{R.stopPropagation(),F(n.id),M({title:n.title,address:n.address,city:n.city,province:n.province,postalCode:n.postalCode}),q(!0)},className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-100 transition",title:"Modifica indirizzo",children:e.jsx(De,{className:"w-4 h-4"})})}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"selectedAddressReview",value:n.id,checked:y===n.id.toString(),onChange:()=>_(n.id.toString()),className:"mr-3 text-green-600"}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-base font-semibold text-blue-800 mb-1 flex items-center",children:[e.jsx(xe,{className:"w-4 h-4 mr-1"}),n.title]}),e.jsxs("div",{className:"space-y-1 mt-1 text-sm text-gray-700",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Via:"})," ",n.address]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Città:"})," ",n.city,", ",n.province," ",n.postalCode]}),(()=>{const R=`${n.address}, ${n.city}, ${n.province} ${n.postalCode}`;if(n.deliveryZone){const J=xt(n.deliveryZone.id);if(J)return e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2",style:{backgroundColor:J.color}}),e.jsxs("span",{className:"text-xs font-medium",style:{color:J.color},children:[J.name," - Fasce orarie ottimizzate per questa zona"]})]})}const Z=fe({city:n.city,province:n.province,postalCode:n.postalCode});return Z?e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2",style:{backgroundColor:Z.color}}),e.jsxs("span",{className:"text-xs font-medium",style:{color:Z.color},children:[Z.name," - Fasce orarie ottimizzate per questa zona"]})]}):e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full mr-2 bg-gray-400"}),e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:["Zona non identificata - Debug: ",R]})]})})()]})]})]}),y===n.id.toString()&&e.jsx("div",{className:"absolute bottom-2 right-2 text-green-600",children:e.jsx(Me,{className:"w-5 h-5"})})]},n.id)}),!s&&O.length===0&&e.jsx("div",{className:"border-2 border-red-300 bg-red-50 p-4 rounded-lg text-center",children:e.jsxs("div",{className:"text-red-600 mb-2",children:[e.jsx(xe,{className:"w-8 h-8 mx-auto mb-2"}),e.jsx("p",{className:"font-medium",children:"Nessun indirizzo disponibile"}),e.jsx("p",{className:"text-sm",children:"Torna al primo step per aggiungere un indirizzo"})]})})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center justify-between",style:{color:"#1B5AAB"},children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(pt,{className:"w-5 h-5 mr-2"}),"Data e Orario di Consegna"]}),e.jsxs(le,{variant:"outline",size:"sm",onClick:()=>f(1),className:"text-xs px-3 py-1 border-[#1B5AAB] text-[#1B5AAB] hover:bg-[#1B5AAB] hover:text-white",children:[e.jsx(De,{className:"w-3 h-3 mr-1"}),"Modifica Data"]})]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-2",children:[g.deliveryDate&&e.jsxs("p",{className:"flex items-center",children:[e.jsx(pt,{className:"w-4 h-4 mr-2",style:{color:"#1B5AAB"}}),e.jsx("span",{className:"font-medium",style:{color:"#1B5AAB"},children:"Data: "})," ",new Date(g.deliveryDate).toLocaleDateString("it-IT",{weekday:"long",day:"2-digit",month:"2-digit",year:"numeric"})]}),g.deliveryTimeSlot&&e.jsxs("p",{className:"flex items-center",children:[e.jsx(ls,{className:"w-4 h-4 mr-2",style:{color:"#1B5AAB"}}),e.jsx("span",{className:"font-medium",style:{color:"#1B5AAB"},children:"Orario: "})," ",g.deliveryTimeSlot]})]})]}),e.jsxs("div",{className:"hidden",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",style:{color:"#1B5AAB"},children:[e.jsx(mt,{className:"w-5 h-5 mr-2"}),"Prodotti Ordinati"]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-3",children:t.items.map(n=>{var P;return e.jsxs("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg border-2",style:{borderColor:ht(n.category),backgroundColor:`${ht(n.category)}10`},children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[n.image&&Array.isArray(n.image)&&n.image.length>0&&e.jsx("img",{src:typeof n.image[0]=="string"?n.image[0]:((P=n.image[0])==null?void 0:P.src)||"",alt:n.name,className:"w-12 h-12 object-cover rounded"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:n.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantità: ",n.quantity]})]})]}),e.jsxs("p",{className:"font-semibold",children:[(n.price*n.quantity).toFixed(2),"€"]})]},n.id)})})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center",style:{color:"#1B5AAB"},children:[e.jsx(cs,{className:"w-5 h-5 mr-2"}),"Note per l'ordine"]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsx(Ps,{name:"orderNotes",value:g.orderNotes,onChange:ze,placeholder:"Inserisci eventuali note per l'ordine ( Cognome sul citofono , piano o istruzioni speciali, ecc.)",className:"min-h-[100px] resize-none border-2",style:{borderColor:"#CFA100"}}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"💡 Puoi utilizzare questo campo per comunicare informazioni aggiuntive come indirizzi di consegna temporanei o istruzioni speciali."})]})]})]}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx("div",{className:"lg:sticky lg:top-6",children:e.jsxs("div",{className:"bg-white border-2 border-gray-200 rounded-lg p-6 shadow-lg",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center text-lg",style:{color:"#1B5AAB"},children:[e.jsx(ds,{className:"w-5 h-5 mr-2"}),"Riepilogo Ordine"]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:[e.jsxs("button",{onClick:()=>N(!A),className:"w-full text-left text-sm text-blue-800 font-medium hover:text-blue-900 transition-colors flex items-center justify-between",children:[e.jsxs("span",{children:[t.items.reduce((n,P)=>n+P.quantity,0)," prodotti nel carrello"]}),e.jsx("span",{className:"text-xs",children:A?"▼":"▶"})]}),A&&e.jsxs("div",{className:"mt-3 space-y-2 border-t border-blue-200 pt-3",children:[t.items.map(n=>{var P;return e.jsxs("div",{className:"bg-white rounded border p-3",children:[e.jsx("div",{className:"flex justify-between items-start mb-2",children:e.jsxs("div",{className:"flex items-center space-x-3 flex-1 min-w-0",children:[n.image&&Array.isArray(n.image)&&n.image.length>0&&e.jsx("img",{src:typeof n.image[0]=="string"?n.image[0]:((P=n.image[0])==null?void 0:P.src)||"",alt:n.name,className:"w-10 h-10 object-cover rounded flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-gray-800 text-sm truncate",children:n.name}),e.jsxs("p",{className:"text-gray-600 text-xs",children:[n.price.toFixed(2),"€ cad."]})]})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center border rounded bg-gray-50",children:[e.jsx("button",{onClick:()=>Qe(n.id,n.quantity-1),className:"px-3 py-1 text-gray-600 hover:bg-gray-200 text-sm font-medium transition-colors",disabled:n.quantity<=1,children:"-"}),e.jsx("span",{className:"px-4 py-1 text-sm font-semibold min-w-[40px] text-center bg-white border-x",children:n.quantity}),e.jsx("button",{onClick:()=>Qe(n.id,n.quantity+1),className:"px-3 py-1 text-gray-600 hover:bg-gray-200 text-sm font-medium transition-colors",children:"+"})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-gray-900 text-base",children:[(n.price*n.quantity).toFixed(2),"€"]})})]})]},n.id)}),e.jsx("div",{className:"border-t pt-3 mt-3",children:e.jsxs("div",{className:"flex justify-between items-center text-sm font-semibold text-blue-800 bg-blue-50 p-3 rounded",children:[e.jsx("span",{children:"Subtotale prodotti:"}),e.jsxs("span",{className:"text-base",children:[Le().toFixed(2),"€"]})]})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-gray-700",children:[e.jsx("span",{children:"Subtotale:"}),e.jsxs("span",{className:"font-medium",children:[Le().toFixed(2),"€"]})]}),e.jsxs("div",{className:"flex justify-between text-gray-700",children:[e.jsx("span",{children:"Spedizione:"}),e.jsx("span",{className:"text-green-600 font-medium",children:"Gratuita"})]}),e.jsxs("div",{className:"border-t-2 pt-3 flex justify-between font-bold text-xl",style:{color:"#A40800"},children:[e.jsx("span",{children:"Totale:"}),e.jsxs("span",{children:[Ie().toFixed(2),"€"]})]})]}),e.jsxs("div",{className:"mt-6 p-3 bg-green-50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-green-800",children:"✅ Spedizione gratuita inclusa"}),e.jsx("p",{className:"text-sm text-green-800 mt-1",children:"🚚 Consegna programmata"})]})]})})})]})});case 3:return We?e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(ye,{className:"w-6 h-6 animate-spin"})}):e.jsx(na,{paymentGatewaysLoading:We,filteredPaymentGateways:Se,paymentMethod:me,setPaymentMethod:Ke,expandedPaymentDetails:Rt,setExpandedPaymentDetails:Mt,orderTotal:Ie().toFixed(2),onPayPalSuccess:Wt,onPayPalError:Kt,onStripeSuccess:Vt,onStripeError:Ht});default:return null}},[Zt,Xe]=m.useState(!1),Le=()=>t.items.reduce((l,d)=>l+d.price*d.quantity,0),Qe=(l,d)=>{d<=0?r({type:"REMOVE_ITEM",payload:l}):r({type:"UPDATE_QUANTITY",payload:{id:l,quantity:d}})},Jt=()=>0,Ie=()=>{const l=Le(),d=Jt();let x=0;return me==="paypal"&&(x=parseFloat((l*.035+.5).toFixed(2))),parseFloat((l+d+x).toFixed(2))},Ue=async l=>{var d,x,S,z;Oe(!0);try{let w;if(y==="main")w={first_name:g.firstName,last_name:g.lastName,address_1:g.address,city:g.city,state:g.province,postcode:g.postalCode,country:"IT"};else{const Q=O.find(ke=>ke.id.toString()===y);Q?w={first_name:g.firstName,last_name:g.lastName,address_1:Q.address,city:Q.city,state:Q.province,postcode:Q.postalCode,country:"IT"}:w={first_name:g.firstName,last_name:g.lastName,address_1:g.address,city:g.city,state:g.province,postcode:g.postalCode,country:"IT"}}const G={first_name:g.firstName,last_name:g.lastName,address_1:w.address_1,city:w.city,state:w.state,postcode:w.postcode,country:"IT",email:g.email,phone:g.phone},X={customer_id:B,payment_method:me,payment_method_title:((d=Se.find(Q=>Q.id===me))==null?void 0:d.title)||me,set_paid:!!(me==="paypal"&&l),billing:G,shipping:w,line_items:t.items.map(Q=>({product_id:Q.id,quantity:Q.quantity})),customer_note:g.orderNotes,meta_data:[{key:"Delivery Date",value:`${new Date(g.deliveryDate).toLocaleDateString("it-IT",{day:"numeric",month:"numeric",year:"numeric"})} ${g.deliveryTimeSlot}`},{key:"_orddd_timestamp",value:Math.floor(new Date(g.deliveryDate).getTime()/1e3).toString()},...D?[{key:"Secondo Indirizzo",value:`${K.address}, ${K.city}, ${K.province} ${K.postalCode}`}]:[]],...me==="paypal"&&l&&l.purchase_units&&((z=(S=(x=l.purchase_units[0])==null?void 0:x.payments)==null?void 0:S.captures[0])==null?void 0:z.id)&&{transaction_id:l.purchase_units[0].payments.captures[0].id}},Ne=await o(X);r({type:"CLEAR_CART"}),I.success("Ordine creato con successo!"),i("/order-success",{state:{orderNumber:Ne.number,orderId:Ne.id,total:Ne.total}})}catch(w){console.error("Errore nella creazione dell'ordine:",w),I.error("Errore nella creazione dell'ordine. Riprova.")}finally{Oe(!1)}},Wt=l=>{console.log("PayPal Success:",l),Ue(l)},Kt=l=>{console.error("PayPal Error:",l),I.error("Pagamento PayPal fallito o annullato."),Oe(!1)},Vt=l=>{console.log("Stripe payment successful:",l),Ue(l)},Ht=l=>{console.error("Stripe payment error:",l),I.error("Errore nel pagamento con carta di credito"),Oe(!1)},et=async()=>{if(!es()){I.error("Completa tutti i campi obbligatori");return}if(t.items.length===0){I.error("Il carrello è vuoto");return}me!=="paypal"?await Ue():I.info("Procedi con il pagamento tramite PayPal.")},Yt=async()=>{var l;if(!a.isAuthenticated||!((l=a.user)!=null&&l.id)){console.log("Utente non autenticato, salto il salvataggio automatico");return}try{console.log("=== SALVATAGGIO AUTOMATICO DATI PERSONALI ==="),console.log("Dati da salvare:",{firstName:g.firstName,lastName:g.lastName,email:g.email,phone:g.phone}),await u.mutateAsync({id:a.user.id,customerData:{first_name:g.firstName,last_name:g.lastName,email:g.email,billing:{...s==null?void 0:s.billing,first_name:g.firstName,last_name:g.lastName,email:g.email,phone:g.phone},shipping:{...s==null?void 0:s.shipping,first_name:g.firstName,last_name:g.lastName}}}),console.log("Dati personali salvati automaticamente con successo"),I.success("Dati personali aggiornati automaticamente!")}catch(d){console.error("Errore nel salvataggio automatico dei dati personali:",d)}},Xt=async()=>{if(p===Y.length-1)et();else if(p<Y.length-1&&be(p)){b(!0);try{if(p===0&&await Yt(),p===2&&(!g.deliveryDate||!g.deliveryTimeSlot)){f(1);return}await new Promise(l=>setTimeout(l,500)),f(p+1)}finally{b(!1)}}},Qt=()=>{p>0&&f(p-1)},es=()=>be(0)&&be(1)&&be(2)&&be(3);return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(bs,{}),e.jsx("div",{className:"pt-10 md:pt-16"}),e.jsx("div",{className:"fixed top-[120px] md:top-[165px] left-0 right-0 bg-white shadow-md z-40",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsx("div",{className:"flex border-b border-gray-200",children:Y.map((l,d)=>{const x=l.icon,S=p===d,z=p>d,w=d<=p||be(d-1)||d===0;return e.jsx("button",{onClick:()=>{w&&(d===0&&C(!1),f(d))},disabled:!w,className:`flex-1 py-3 md:py-2 px-1 text-center border-b-2 font-medium text-xs transition-colors ${S?"border-[#1B5AAB] text-[#1B5AAB]":z?"border-green-500 text-green-600":w?"border-transparent text-gray-500 hover:text-gray-700":"border-transparent text-gray-300 cursor-not-allowed"}`,children:e.jsxs("div",{className:"flex flex-col items-center space-y-1",children:[e.jsx(x,{className:"w-5 h-5 md:w-4 md:h-4"}),e.jsx("span",{className:"text-xs hidden md:block",children:l.name})]})},l.id)})})})}),e.jsx("div",{className:"pt-4 md:pt-1"}),e.jsxs("div",{className:"max-w-4xl mx-auto pb-32 md:pb-16",children:[e.jsxs(Ns,{className:"shadow-lg",children:[e.jsx(js,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 py-3",children:e.jsxs(As,{className:"flex items-center text-base font-bold text-[#1B5AAB]",children:[Pe.createElement(Y[p].icon,{className:"w-5 h-5 mr-2"}),Y[p].name]})}),e.jsx(Cs,{className:"p-3",children:Gt()})]}),e.jsx("div",{className:"fixed bottom-16 md:bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 z-50",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex justify-between",children:[e.jsxs(le,{variant:"outline",onClick:()=>{p===0||p===1&&a.isAuthenticated?i("/cart"):Qt()},className:"px-6 py-2 text-sm",children:[e.jsx(rs,{className:"w-4 h-4 mr-1"}),p===0||p===1&&a.isAuthenticated?"Torna al Carrello":"Indietro"]}),p<Y.length-1?e.jsx(le,{onClick:Xt,disabled:!be(p)||c,className:"px-6 py-2 text-sm gradient-primary",children:c?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-1 animate-spin"}),"Caricamento..."]}):"Continua"}):e.jsx(le,{onClick:Ie()===0?()=>i("/products"):et,disabled:He||!be(p),className:"px-6 py-2 text-sm gradient-primary",children:He?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-1 animate-spin"}),"Elaborazione..."]}):Ie()===0?"Nessun Prodotto Selezionato - Vai allo SHOP":`Completa Ordine - ${Ie().toFixed(2)}€`})]})})]}),s&&e.jsx(yt,{open:Zt,onOpenChange:Xe,children:e.jsxs(vt,{children:[e.jsxs(bt,{children:[e.jsx(Nt,{children:"Modifica Indirizzo"}),e.jsx(jt,{children:"Modifica le informazioni del tuo indirizzo di consegna."})]}),e.jsx(Ss,{customer:s,onClose:()=>Xe(!1)})]})}),e.jsx(yt,{open:ne,onOpenChange:q,children:e.jsxs(vt,{className:"max-w-sm mx-2 sm:mx-4 rounded-xl shadow-2xl border-0 max-h-[85vh] overflow-y-auto",children:[e.jsxs(bt,{className:"space-y-1 pb-2",children:[e.jsxs(Nt,{className:"flex items-center text-lg sm:text-xl font-bold text-gray-800",children:[e.jsx(xe,{className:"w-5 h-5 sm:w-6 sm:h-6 mr-2",style:{color:"#1B5AAB"}}),k?"Modifica Indirizzo":"Nuovo Indirizzo"]}),e.jsx(jt,{className:"text-gray-600 text-sm sm:text-base leading-relaxed",children:k?"Modifica i dettagli del tuo indirizzo.":"Aggiungi un nuovo indirizzo."})]}),e.jsxs("div",{className:"space-y-2 sm:space-y-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"editTitle",className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:"Titolo (es. Casa, Ufficio)"}),e.jsx(re,{id:"editTitle",name:"title",value:h.title,onChange:ve,placeholder:"Casa",className:`h-8 sm:h-9 focus:ring-[#1B5AAB] rounded-md text-[#1B5AAB] placeholder:text-[#1B5AAB]/60 selection:bg-[#1B5AAB]/20 text-sm ${de.address?"border-red-500 focus:border-red-500":"border-gray-300 focus:border-[#1B5AAB]"}`})]}),e.jsx("div",{children:e.jsx(At,{label:"Indirizzo",placeholder:"Inizia a digitare l'indirizzo...",value:h.address,onChange:l=>{M({...h,address:l})},onAddressSelect:l=>{M({...h,address:l.address,city:l.city,province:l.province,postalCode:l.postalCode})},error:de.address,required:!0,focusTargetId:"save-address-button"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:gap-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"editCity",className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:"Città *"}),e.jsx(re,{id:"editCity",name:"city",value:h.city,onChange:ve,placeholder:"Inserisci la Città",className:`h-8 sm:h-9 focus:ring-[#1B5AAB] rounded-md text-[#1B5AAB] placeholder:text-[#1B5AAB]/60 selection:bg-[#1B5AAB]/20 text-sm ${de.city?"border-red-500 focus:border-red-500":"border-gray-300 focus:border-[#1B5AAB]"}`,required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{htmlFor:"editProvince",className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:"Provincia *"}),e.jsx(re,{id:"editProvince",name:"province",value:h.province,onChange:ve,placeholder:"Inserisci la Provincia",className:`h-8 sm:h-9 focus:ring-[#1B5AAB] rounded-md text-[#1B5AAB] placeholder:text-[#1B5AAB]/60 selection:bg-[#1B5AAB]/20 text-sm ${de.province?"border-red-500 focus:border-red-500":"border-gray-300 focus:border-[#1B5AAB]"}`,required:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:gap-3",children:[e.jsxs("div",{children:[e.jsx(V,{htmlFor:"editPostalCode",className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:"CAP *"}),e.jsx(re,{id:"editPostalCode",name:"postalCode",value:h.postalCode,onChange:ve,placeholder:"Inserisci il Cap",className:`h-8 sm:h-9 focus:ring-[#1B5AAB] rounded-md text-[#1B5AAB] placeholder:text-[#1B5AAB]/60 selection:bg-[#1B5AAB]/20 text-sm ${de.postalCode?"border-red-500 focus:border-red-500":"border-gray-300 focus:border-[#1B5AAB]"}`,required:!0})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:"Paese"}),e.jsx(re,{value:"IT",className:"h-8 sm:h-9 bg-gray-50 border-gray-200 text-gray-500 rounded-md text-sm",readOnly:!0})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(le,{variant:"outline",onClick:()=>{q(!1),F(null),M({title:"",address:"",city:"",province:"",postalCode:""})},className:"flex-1 h-8 sm:h-9 border-2 border-gray-300 text-gray-700 hover:bg-[#A40800] hover:text-white hover:border-[#A40800] transition-all duration-200 rounded-md font-medium text-sm",children:"Annulla"}),e.jsx(le,{id:"save-address-button",onClick:async()=>{var d,x;Ee({});const l={};if(h.address||(l.address=!0),h.city||(l.city=!0),h.province||(l.province=!0),h.postalCode||(l.postalCode=!0),Object.keys(l).length>0){Ee(l),I.error("Compila tutti i campi obbligatori evidenziati in rosso");return}ee(!0);try{if(k)if(k==="main")await u.mutateAsync({id:B,customerData:{shipping:{first_name:(s==null?void 0:s.first_name)||"",last_name:(s==null?void 0:s.last_name)||"",company:"",address_1:h.address,address_2:"",city:h.city,state:h.province,postcode:h.postalCode,country:"IT"},billing:{first_name:(s==null?void 0:s.first_name)||"",last_name:(s==null?void 0:s.last_name)||"",company:"",address_1:h.address,address_2:"",city:h.city,state:h.province,postcode:h.postalCode,country:"IT",email:(s==null?void 0:s.email)||"",phone:((d=s==null?void 0:s.billing)==null?void 0:d.phone)||""}}}),I.success("Indirizzo principale aggiornato!");else{const S={title:h.title||((x=O.find(z=>z.id===k))==null?void 0:x.title),address:h.address,city:h.city,province:h.province,postalCode:h.postalCode};await qt(k.toString(),S)}else await Ye();q(!1),F(null),M({title:"",address:"",city:"",province:"",postalCode:""})}catch(S){console.error("Errore nel salvataggio:",S),I.error("Errore nel salvataggio dell'indirizzo")}finally{ee(!1)}},disabled:Ae,className:"flex-1 h-8 sm:h-9 bg-[#1B5AAB] hover:bg-[#164a94] text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 rounded-md font-medium shadow-lg hover:shadow-xl text-sm",children:Ae?e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(ye,{className:"w-3 h-3 sm:w-4 sm:h-4 animate-spin"}),e.jsx("span",{className:"hidden sm:inline",children:"Salvando..."}),e.jsx("span",{className:"sm:hidden",children:"..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"hidden sm:inline",children:k?"Salva Modifiche":"Salva Indirizzo"}),e.jsx("span",{className:"sm:hidden",children:"Salva"})]})})]})]})]})})]})};export{Ca as default};
