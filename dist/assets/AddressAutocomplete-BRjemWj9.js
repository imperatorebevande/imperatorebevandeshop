import{j as o,s as Q,ab as W,M as X}from"./ui-vendor-CBu0MraC.js";import{r as a}from"./react-vendor-DTdTrAaS.js";import{I as Y}from"./input-BrCX-FV-.js";import{L as ee}from"./label-BP42n_nh.js";const U=()=>typeof window<"u"&&typeof window.google<"u"&&typeof window.google.maps<"u"&&typeof window.google.maps.places<"u",G=()=>new Promise((i,l)=>{if(U()){i();return}const s=setInterval(()=>{U()&&(clearInterval(s),i())},100);setTimeout(()=>{clearInterval(s),l(new Error("Google Maps API failed to load"))},1e4)});async function ne(i){try{await G();const l=`${i.address}, ${i.city}, ${i.province}, ${i.postalCode}, Italy`,s=new window.google.maps.Geocoder;return new Promise(x=>{s.geocode({address:l,componentRestrictions:{country:"IT"},region:"it"},(d,L)=>{if(L==="OK"&&d&&d.length>0){const B=d[0],P=B.geometry.location;x({lat:P.lat(),lng:P.lng(),formatted_address:B.formatted_address})}else console.warn("Geocoding fallito:",L),x(null)})})}catch(l){return console.error("Errore nel geocoding dell'indirizzo:",l),null}}function ae(){return new Promise(i=>{if(!navigator.geolocation){console.warn("Geolocalizzazione non supportata dal browser"),i(null);return}navigator.geolocation.getCurrentPosition(l=>{i({lat:l.coords.latitude,lng:l.coords.longitude,formatted_address:"Posizione corrente"})},l=>{console.warn("Errore nell'ottenere la posizione corrente:",l),i(null)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})})}const ie=({label:i,placeholder:l,value:s,onChange:x,onAddressSelect:d,className:L="",required:B=!1,error:P=!1,focusTargetId:N})=>{const[y,w]=a.useState([]),[H,C]=a.useState(!1),[K,u]=a.useState(!1),[S,v]=a.useState(-1),[m,j]=a.useState(!1),[f,_]=a.useState(!1),[n,Z]=a.useState(!1),$=a.useRef(null),M=a.useRef(null),E=a.useRef(),O=async(e,t=!1)=>{if(e.length<3){w([]);return}if(!(m||n||f&&!t)){C(!0);try{await G();const b=new window.google.maps.places.AutocompleteService,g={input:e,componentRestrictions:{country:"it"},types:["address"],bounds:new window.google.maps.LatLngBounds(new window.google.maps.LatLng(41,16.7),new window.google.maps.LatLng(41.2,17)),location:new window.google.maps.LatLng(41.1171,16.8719),radius:15e3};b.getPlacePredictions(g,(z,h)=>{if(h===window.google.maps.places.PlacesServiceStatus.OK&&z){const I=["bari","ba","puglia","apulia","bitonto","molfetta","terlizzi","ruvo","corato","andria","trani","bisceglie","mola","polignano","monopoli","conversano","triggiano","capurso","cellamare","valenzano","modugno","bitetto","palo del colle","grumo appula","binetto","toritto","adelfia","casamassima","sammichele","turi","putignano","castellana grotte","alberobello","locorotondo","fasano","cisternino","ostuni","ceglie messapica","san vito dei normanni","villa castelli","francavilla fontana","oria","latiano","mesagne","san donaci","cellino san marco","san pietro vernotico","torchiarolo","brindisi"],D=z.filter(r=>{const A=r.description.toLowerCase();return I.some(k=>A.includes(k))}).sort((r,A)=>{const k=r.description.toLowerCase(),c=A.description.toLowerCase(),p=k.includes("bari"),V=c.includes("bari");return p&&!V?-1:!p&&V?1:0}).map(r=>({place_id:r.place_id,description:r.description,structured_formatting:r.structured_formatting,types:r.types}));w(D),u(!0)}else w([]),u(!1);C(!1)})}catch(b){console.error("Errore nella ricerca indirizzi:",b),C(!1)}}};a.useEffect(()=>{if(!(m||n||f))return E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{s&&!m&&!n&&!f?O(s):(w([]),u(!1))},300),()=>{E.current&&clearTimeout(E.current)}},[s,m,n,f]),a.useEffect(()=>{(m||n||f)&&(w([]),u(!1))},[m,n,f]),a.useEffect(()=>{!s&&f&&_(!1)},[s,f]);const q=e=>{if(!K||y.length===0){e.key==="Enter"&&s&&d&&J();return}switch(e.key){case"ArrowDown":e.preventDefault(),v(t=>t<y.length-1?t+1:0);break;case"ArrowUp":e.preventDefault(),v(t=>t>0?t-1:y.length-1);break;case"Enter":e.preventDefault(),S>=0&&S<y.length&&F(y[S]);break;case"Escape":u(!1),v(-1);break}},J=()=>{if(!s||!d)return;const e=s.trim().split(" ");e[e.length-1],d({address:s,city:"",province:"BA",postalCode:""})},F=async e=>{if(j(!0),_(!0),u(!1),v(-1),w([]),d)try{await G();const t=new window.google.maps.places.PlacesService(document.createElement("div")),b={placeId:e.place_id,fields:["address_components","formatted_address","geometry"]};t.getDetails(b,(g,z)=>{if(z===window.google.maps.places.PlacesServiceStatus.OK&&g){let h="",I="",R="BA",T="",D;g.geometry&&g.geometry.location&&(D={lat:g.geometry.location.lat(),lng:g.geometry.location.lng()});let r="",A="";g.address_components&&g.address_components.forEach(c=>{const p=c.types;p.includes("route")?r=c.long_name:p.includes("street_number")?A=c.long_name:p.includes("locality")||p.includes("administrative_area_level_3")?I=c.long_name:p.includes("administrative_area_level_2")?R=c.short_name:p.includes("postal_code")&&(T=c.long_name)}),/\d+[a-zA-Z]?$/.test(s.trim())&&s.trim().toLowerCase().includes(r.toLowerCase())?h=s.trim():r&&A?h=`${r} ${A}`:r?h=r:h=e.structured_formatting.main_text,d&&d({address:h,city:I,province:R,postalCode:T,coordinates:D}),x(h),N&&setTimeout(()=>{const c=document.getElementById(N);c&&c.focus()},100),setTimeout(()=>{j(!1)},5e3)}})}catch(t){console.error("Errore nel recupero dettagli indirizzo:",t),setTimeout(()=>{j(!1)},800)}else N&&setTimeout(()=>{const t=document.getElementById(N);t&&t.focus()},100),setTimeout(()=>{j(!1)},800)};return a.useEffect(()=>{const e=t=>{$.current&&!$.current.contains(t.target)&&M.current&&!M.current.contains(t.target)&&(u(!1),v(-1))};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),o.jsxs("div",{className:"relative",children:[o.jsxs(ee,{className:"text-xs sm:text-sm font-semibold text-[#1B5AAB] mb-1 block",children:[i," ",B&&"*"]}),o.jsxs("div",{className:"relative",children:[o.jsx(Y,{ref:$,value:s,onChange:e=>{const t=e.target.value;m||(f?(x(t),t||_(!1)):x(t))},onKeyDown:q,onFocus:()=>{!n&&!m&&(x(""),_(!1),w([]),u(!1))},placeholder:n?"Inserimento manuale - Digita l'indirizzo completo":l||"Inserisci via e numero civico (es. Via Roma 123) - Premi Enter per confermare",className:`h-8 sm:h-9 focus:ring-[#1B5AAB] rounded-md text-[#1B5AAB] placeholder:text-[#1B5AAB]/60 selection:bg-[#1B5AAB]/20 text-sm pr-20 ${P?"border-red-500 focus:border-red-500":"border-gray-300 focus:border-[#1B5AAB]"} ${L}`,required:B}),H&&o.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:o.jsx(Q,{className:"w-4 h-4 animate-spin text-[#1B5AAB]"})}),!H&&o.jsxs("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center gap-2",children:[o.jsx("button",{type:"button",onClick:e=>{e.preventDefault(),e.stopPropagation(),Z(!n),n?s&&s.length>=3&&O(s,!0):(w([]),u(!1),_(!1))},className:`p-1 rounded transition-colors ${n?"bg-[#1B5AAB] text-white":"bg-[#1B5AAB]/10 text-[#1B5AAB] hover:bg-[#1B5AAB]/20"}`,title:n?"Disattiva inserimento manuale":"Attiva inserimento manuale",children:o.jsx(W,{className:"w-3 h-3"})}),n&&o.jsx("div",{className:"text-xs text-[#1B5AAB] bg-[#1B5AAB]/10 px-2 py-1 rounded font-medium",children:"Manuale"})]})]}),K&&y.length>0&&!m&&!n&&o.jsx("div",{ref:M,className:"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:y.map((e,t)=>o.jsxs("div",{className:`px-3 py-2 cursor-pointer flex items-start gap-2 hover:bg-blue-50 ${t===S?"bg-blue-100":""}`,onClick:b=>{b.preventDefault(),b.stopPropagation(),F(e)},children:[o.jsx(X,{className:"w-4 h-4 text-[#1B5AAB] mt-0.5 flex-shrink-0"}),o.jsxs("div",{className:"flex-1 min-w-0",children:[o.jsx("div",{className:"text-sm font-medium text-gray-900 truncate",children:e.structured_formatting.main_text}),o.jsx("div",{className:"text-xs text-gray-500 truncate",children:e.structured_formatting.secondary_text})]})]},t))})]})};export{ie as A,ne as a,ae as g};
