import{j as e,v as E,w as I,x as R,y as w}from"./ui-vendor-BbdbCsUZ.js";import{r as h}from"./react-vendor-DTdTrAaS.js";import{D as A,a as S,b as T,c as k}from"./dialog-rh9CTZ6-.js";import{B as d}from"./button-DV96QXU2.js";import{a as L,J as c,w as P}from"./index-CU51xw2J.js";import{u as z}from"./router-vendor-Dt4hhyuR.js";const H=({isOpen:j,onClose:x,lastOrder:a})=>{var y;const{dispatch:N}=L(),g=z(),[m,u]=h.useState(!1),[o,f]=h.useState({});h.useEffect(()=>{if(a&&a.line_items){const t={};a.line_items.forEach((s,n)=>{t[n]=s.quantity}),f(t)}},[a]);const q=t=>{if(!t.categories||t.categories.length===0)return"altri";const s=t.categories[0].slug.toLowerCase();return s==="acqua"||s.includes("acqua-")?"acqua":s==="birra"||s.includes("birra-")?"birra":s==="vino"||s.includes("vino-")?"vino":s==="bevande"||s.includes("bevande-")||s==="cocacola"||s==="fanta"||s==="sanbenedetto"||s==="sanpellegrino"||s==="schweppes"||s.includes("altre-bevande")?"bevande":"altri"},b=(t,s)=>{s>=0&&f(n=>({...n,[t]:s}))},F=t=>{b(t,(o[t]||0)+1)},_=t=>{b(t,Math.max(0,(o[t]||0)-1))},v=()=>!a||!a.line_items?0:a.line_items.reduce((t,s,n)=>{const r=o[n]||0,i=parseFloat(s.price);return t+i*r},0),C=async()=>{if(!a||!a.line_items){c.error("Nessun ordine precedente trovato");return}u(!0);let t=0;try{c.info("Aggiunta prodotti al carrello...");const s=a.line_items.map(async r=>{try{const i=await P.getProduct(r.product_id),l=q(i);return{cartItem:{id:r.product_id,name:r.name,price:parseFloat(r.price),image:i.images&&i.images.length>0?i.images[0].src:"/placeholder.svg",category:l},quantity:r.quantity}}catch(i){return console.error(`Errore nel recupero del prodotto ${r.product_id}:`,i),{cartItem:{id:r.product_id,name:r.name,price:parseFloat(r.price),image:"/placeholder.svg",category:"altri"},quantity:r.quantity}}});if((await Promise.all(s)).forEach(({cartItem:r},i)=>{const l=o[i]||0;if(l>0){for(let p=0;p<l;p++)N({type:"ADD_ITEM",payload:r});t+=l}}),t>0)c.success(`${t} prodotti dall'ultimo ordine aggiunti al carrello!`);else{c.info("Nessun prodotto selezionato per l'aggiunta al carrello"),u(!1);return}x(),setTimeout(()=>{g("/cart")},1500)}catch(s){console.error("Errore nel recupero dei prodotti:",s),c.error("Errore nel recupero delle informazioni dei prodotti")}finally{u(!1)}},D=()=>{x(),g("/prodotti")};return a?e.jsx(A,{open:j,onOpenChange:x,children:e.jsxs(S,{className:"max-w-2xl max-h-[90vh] overflow-y-auto !top-4 !translate-y-0 !left-[50%] !translate-x-[-50%] mx-4 sm:mx-0 w-[calc(100vw-2rem)] sm:w-full",children:[e.jsx(T,{children:e.jsxs(k,{className:"text-2xl font-bold text-center text-[#1B5AAB] flex items-center justify-center gap-2",children:[e.jsx(E,{className:"h-6 w-6"}),"Riordina Ultimo Acquisto"]})}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-6 border border-blue-200",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-4 text-center",children:"ðŸŽ¯ Cosa vuoi fare oggi?"}),e.jsxs("div",{className:"bg-white rounded-xl p-3 sm:p-5 border-2 border-blue-200 shadow-lg mb-4 sm:mb-6",children:[e.jsxs("h4",{className:"font-bold text-gray-900 mb-3 sm:mb-4 text-sm sm:text-base flex items-center gap-2 flex-wrap",children:["ðŸ“‹ Ultimo Ordine #",a.number,e.jsxs("span",{className:"text-sm font-normal text-gray-600",children:["- ",new Date(a.date_created).toLocaleDateString("it-IT")]})]}),e.jsx("div",{className:"space-y-2 sm:space-y-3 max-h-48 sm:max-h-64 overflow-y-auto",children:(y=a.line_items)==null?void 0:y.map((t,s)=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center text-xs sm:text-sm bg-gradient-to-r from-gray-50 to-gray-100 p-2 sm:p-3 rounded-lg border border-gray-200 gap-2 sm:gap-0",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-semibold text-gray-900 block truncate",children:t.name}),e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["â‚¬",parseFloat(t.price).toFixed(2)," cad."]})]}),e.jsxs("div",{className:"flex items-center justify-between sm:gap-3 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 bg-white rounded-lg border border-gray-300 p-1",children:[e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>_(s),className:"h-6 w-6 sm:h-8 sm:w-8 p-0 hover:bg-red-100 hover:text-red-600",disabled:m,children:e.jsx(I,{className:"h-3 w-3 sm:h-4 sm:w-4"})}),e.jsx("span",{className:"font-bold text-sm sm:text-lg min-w-[1.5rem] sm:min-w-[2rem] text-center",children:o[s]||0}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>F(s),className:"h-6 w-6 sm:h-8 sm:w-8 p-0 hover:bg-green-100 hover:text-green-600",disabled:m,children:e.jsx(R,{className:"h-3 w-3 sm:h-4 sm:w-4"})})]}),e.jsx("div",{className:"text-right min-w-[3rem] sm:min-w-[4rem]",children:e.jsxs("div",{className:"font-bold text-gray-900",children:["â‚¬",((o[s]||0)*parseFloat(t.price)).toFixed(2)]})})]})]},s))}),e.jsx("div",{className:"mt-4 pt-3 border-t-2 border-gray-200 text-right",children:e.jsxs("div",{className:"space-y-1",children:[v()!==parseFloat(a.total)&&e.jsxs("div",{className:"text-xs sm:text-sm text-gray-500 line-through",children:["Originale: â‚¬",parseFloat(a.total).toFixed(2)]}),e.jsxs("span",{className:"font-bold text-lg sm:text-xl text-green-600",children:["ðŸ’° Totale: â‚¬",v().toFixed(2)]})]})})]}),e.jsxs("div",{className:"space-y-3 sm:space-y-4",children:[e.jsx(d,{onClick:C,disabled:m||Object.values(o).every(t=>t===0),className:"w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 sm:py-6 px-6 sm:px-8 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 font-bold text-lg sm:text-xl shadow-lg hover:shadow-xl transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 sm:h-6 sm:w-6 border-b-2 border-white"}),e.jsx("span",{className:"hidden sm:inline",children:"Aggiunta in corso..."}),e.jsx("span",{className:"sm:hidden",children:"Aggiunta..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"h-5 w-5 sm:h-6 sm:w-6"}),e.jsx("span",{className:"hidden sm:inline",children:"Ripeti questo Ordine"}),e.jsx("span",{className:"sm:hidden",children:"Ripeti Ordine"})]})}),e.jsxs(d,{onClick:D,variant:"outline",className:"w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 sm:py-4 px-4 sm:px-6 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-300 flex items-center justify-center gap-2 sm:gap-3 font-semibold text-base sm:text-lg shadow-lg hover:shadow-xl transform hover:scale-105",children:[e.jsx(w,{className:"h-4 w-4 sm:h-5 sm:w-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Continua sul Sito"}),e.jsx("span",{className:"sm:hidden",children:"Nuovo Ordine"})]})]})]})})]})}):null};export{H as R};
